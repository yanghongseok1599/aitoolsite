rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId || request.auth.token.email == userId;
    }

    // Bookmarks collection
    match /bookmarks/{bookmarkId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // User settings collection
    match /userSettings/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // Widget settings collection
    match /widgetSettings/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // Notes collection
    match /notes/{noteId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Events (Calendar) collection
    match /events/{eventId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Todos collection
    match /todos/{todoId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Site settings (admin only - ad banners, etc.)
    match /siteSettings/{settingId} {
      allow read: if true;  // Everyone can read site settings
      allow write: if isAuthenticated();  // Only authenticated users can write
    }

    // Admin settings collection
    match /admin/{document=**} {
      allow read: if true;  // Everyone can read admin settings (site name, logo, etc.)
      allow write: if isAuthenticated();  // Only authenticated users can write
    }

    // Users collection (managed by server-side Admin SDK)
    match /users/{userId} {
      allow read: if true;  // Admin SDK handles read from server
      allow write: if false;  // Only Admin SDK can write
    }
  }
}
